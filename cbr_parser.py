# üì¶ –ò–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
import requests                  # –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ HTML —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¶–ë
import pandas as pd              # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏
from bs4 import BeautifulSoup    # –î–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML-–∫–æ–¥–∞ (–∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã)
from datetime import date        # –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –≤ –∏–º—è —Ñ–∞–π–ª–∞

# üß© –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
def load_cbr_data():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç —Å —Å–∞–π—Ç–∞ –¶–ë –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ—ë –≤ CSV."""

    # üåê 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –∫—É—Ä—Å–∞–º–∏ –≤–∞–ª—é—Ç
    url = "https://www.cbr.ru/currency_base/daily/"
    response = requests.get(url)          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    response.encoding = "utf-8"           # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –∫–æ–¥–∏—Ä–æ–≤–∫—É

    # üßæ 2. –ü–∞—Ä—Å–∏–º HTML –∏ –Ω–∞—Ö–æ–¥–∏–º —Ç–∞–±–ª–∏—Ü—É
    soup = BeautifulSoup(response.text, "html.parser")  # –†–∞–∑–±–∏—Ä–∞–µ–º HTML
    table = soup.find("table", class_="data")           # –ò—â–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ –∫–ª–∞—Å—Å—É "data"

    # üè∑Ô∏è 3. –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (–Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤)
    headers = [th.text.strip() for th in table.find_all("th")]

    # üî¢ 4. –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
    rows = []
    for tr in table.find_all("tr")[1:]:                 # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
        cells = [td.text.strip() for td in tr.find_all("td")]  # –î–æ—Å—Ç–∞—ë–º —Ç–µ–∫—Å—Ç —è—á–µ–µ–∫
        if cells:                                       # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –ø—É—Å—Ç–∞—è
            rows.append(cells)                          # –î–æ–±–∞–≤–ª—è–µ–º –µ—ë –≤ —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫

    # üßÆ 5. –°–æ–∑–¥–∞—ë–º DataFrame –∏–∑ —Å—Ç—Ä–æ–∫ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    df = pd.DataFrame(rows, columns=headers)

    # üá∑üá∫ 6. –î–æ–±–∞–≤–ª—è–µ–º —Ä—É–±–ª—å –≤—Ä—É—á–Ω—É—é (–µ–≥–æ –Ω–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ –¶–ë)
    # –§–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫–∏: [–¶–∏—Ñ—Ä–æ–≤–æ–π –∫–æ–¥, –ë—É–∫–≤–µ–Ω–Ω—ã–π –∫–æ–¥, –ï–¥–∏–Ω–∏—Ü, –í–∞–ª—é—Ç–∞, –ö—É—Ä—Å]
    rub_row = pd.DataFrame(
        [["643", "RUB", "1", "–†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å", "1,0000"]],
        columns=headers
    )
    df = pd.concat([df, rub_row], ignore_index=True)    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Ä—É–±–ª—è –≤ —Ç–∞–±–ª–∏—Ü—É

    # üî£ 7. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω—É–∂–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã –∫ —á–∏—Å–ª–∞–º
    df["–ï–¥–∏–Ω–∏—Ü"] = df["–ï–¥–∏–Ω–∏—Ü"].astype(int)             # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º "–ï–¥–∏–Ω–∏—Ü" –≤ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
    df["–ö—É—Ä—Å"] = df["–ö—É—Ä—Å"].str.replace(",", ".").astype(float)  # –ú–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—ã–µ –Ω–∞ —Ç–æ—á–∫–∏ –∏ –¥–µ–ª–∞–µ–º float

    # üíæ 8. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É –≤ CSV-—Ñ–∞–π–ª
    filename = f"currency_rates_{date.today()}.csv"      # –ò–º—è —Ñ–∞–π–ª–∞ —Å —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç–æ–π
    df.to_csv(filename, index=False, encoding="utf-8-sig")  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª

    # ‚úÖ 9. –í—ã–≤–æ–¥–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º DataFrame
    print(f"‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª {filename}")
    return df  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–ª—å—à–µ
